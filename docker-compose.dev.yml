# This file overrides settings in docker-compose.yml for development
services:
  api-gateway:
    build:
      context: .
      dockerfile: ./backend/api-gateway/Dockerfile.dev
    volumes:
      - ./backend:/app/backend # Mount local backend code
    working_dir: /app/backend/api-gateway
    command: ["air", "-c", ".air.toml"]
    depends_on:
      user-service:
        condition: service_started
      post-service:
        condition: service_started
      story-service:
        condition: service_started
      media-service:
        condition: service_started
      message-service:
        condition: service_started
      report-service:
        condition: service_started
      hashtag-service: # <-- ADD THIS
        condition: service_started

  user-service:
    build:
      context: .
      dockerfile: ./backend/user-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/user-service
    command: ["air", "-c", ".air.toml"]

  post-service:
    build:
      context: .
      dockerfile: ./backend/post-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/post-service
    command: ["air", "-c", ".air.toml"]

  story-service:
    build:
      context: .
      dockerfile: ./backend/story-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/story-service
    command: ["air", "-c", ".air.toml"]

  media-service:
    build:
      context: .
      dockerfile: ./backend/media-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/media-service
    command: ["air", "-c", ".air.toml"]

  message-service:
    build:
      context: .
      dockerfile: ./backend/message-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/message-service
    command: ["air", "-c", ".air.toml"]
    ports:
      - "9004:9004"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.message-ws.rule=Host(`api.hoshi.local`) && PathPrefix(`/ws`)"
      - "traefik.http.routers.message-ws.entrypoints=web"
      - "traefik.http.routers.message-ws.priority=100"
      - "traefik.http.services.message-ws.loadbalancer.server.port=9004"

  notification-service:
    build:
      context: .
      dockerfile: ./backend/notification-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/notification-service
    command: ["air", "-c", ".air.toml"]

  email-service:
    build:
      context: .
      dockerfile: ./backend/email-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/email-service
    command: ["air", "-c", ".air.toml"]

  worker-service:
    build:
      context: .
      dockerfile: ./backend/worker-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/worker-service
    command: ["air", "-c", ".air.toml"]
    depends_on: # <-- ADD THIS BLOCK
      hashtag-service:
        condition: service_started

  ai-service:
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "9008", "--reload"]
    volumes:
      - ./backend/ai-service:/app
  
  report-service:
    build:
      context: .
      dockerfile: ./backend/report-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/report-service
    command: ["air", "-c", ".air.toml"]
  
  hashtag-service:
    build:
      context: .
      dockerfile: ./backend/hashtag-service/Dockerfile.dev
    volumes:
      - ./backend:/app/backend
    working_dir: /app/backend/hashtag-service
    command: ["air", "-c", ".air.toml"]