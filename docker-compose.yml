# Note: The 'version' attribute is removed as it's obsolete in modern Docker Compose.

services:
  # ==================================================================
  # 1. REVERSE PROXY & ENTRYPOINT
  # ==================================================================
  traefik:
    image: "traefik:v2.10"
    container_name: "traefik"
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # --- DISABLED FOR LOCAL DEV ---
      # - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      # - "--certificatesresolvers.myresolver.acme.email=your-email@example.com"
      # - "--certificatesresolvers.myresolver.acme.storage=/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Traefik Dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/acme.json:/acme.json"
    networks:
      - hoshi-net

  # ==================================================================
  # 2. CORE INFRASTRUCTURE
  # ==================================================================
  redis:
    image: redis:7-alpine
    container_name: redis
    # Removed exposed port - internal network only
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD:-guest}
    # Removed exposed ports - internal network only
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio
    container_name: minio
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_SERVER_URL=${MINIO_SERVER_URL:-http://minio:9000}
    command: server /data --console-address ":9001"
    # Removed exposed ports - internal network only
    volumes:
      - minio-data:/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================================================================
  # 3. DATABASES (Database-per-Service)
  # ==================================================================
  user-db:
    image: postgres:15-alpine
    container_name: user-db
    environment:
      - POSTGRES_USER=${USER_DB_USER:-admin}
      - POSTGRES_PASSWORD=${USER_DB_PASSWORD:-password}
      - POSTGRES_DB=${USER_DB_NAME:-user_service_db}
    # Removed exposed port - internal network only
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USER_DB_USER:-admin} -d ${USER_DB_NAME:-user_service_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  post-db:
    image: postgres:15-alpine
    container_name: post-db
    environment:
      - POSTGRES_USER=${POST_DB_USER:-admin}
      - POSTGRES_PASSWORD=${POST_DB_PASSWORD:-password}
      - POSTGRES_DB=${POST_DB_NAME:-post_service_db}
    # Removed exposed port - internal network only
    volumes:
      - post-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POST_DB_USER:-admin} -d ${POST_DB_NAME:-post_service_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  story-db:
    image: postgres:15-alpine
    container_name: story-db
    environment:
      - POSTGRES_USER=${STORY_DB_USER:-admin}
      - POSTGRES_PASSWORD=${STORY_DB_PASSWORD:-password}
      - POSTGRES_DB=${STORY_DB_NAME:-story_service_db}
    # Removed exposed port - internal network only
    volumes:
      - story-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${STORY_DB_USER:-admin} -d ${STORY_DB_NAME:-story_service_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  message-db:
    image: postgres:15-alpine
    container_name: message-db
    environment:
      - POSTGRES_USER=${MESSAGE_DB_USER:-admin}
      - POSTGRES_PASSWORD=${MESSAGE_DB_PASSWORD:-password}
      - POSTGRES_DB=${MESSAGE_DB_NAME:-message_service_db}
    # Removed exposed port - internal network only
    volumes:
      - message-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${MESSAGE_DB_USER:-admin} -d ${MESSAGE_DB_NAME:-message_service_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  notification-db:
    image: postgres:15-alpine
    container_name: notification-db
    environment:
      - POSTGRES_USER=${NOTIFICATION_DB_USER:-admin}
      - POSTGRES_PASSWORD=${NOTIFICATION_DB_PASSWORD:-password}
      - POSTGRES_DB=${NOTIFICATION_DB_NAME:-notification_service_db}
    # Removed exposed port - internal network only
    volumes:
      - notification-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${NOTIFICATION_DB_USER:-admin} -d ${NOTIFICATION_DB_NAME:-notification_service_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  report-db:
    image: postgres:15-alpine
    container_name: report-db
    environment:
      - POSTGRES_USER=${REPORT_DB_USER:-admin}
      - POSTGRES_PASSWORD=${REPORT_DB_PASSWORD:-password}
      - POSTGRES_DB=${REPORT_DB_NAME:-report_service_db}
    # Removed exposed port - internal network only
    volumes:
      - report-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${REPORT_DB_USER:-admin} -d ${REPORT_DB_NAME:-report_service_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  hashtag-db:
    image: postgres:15-alpine
    container_name: hashtag-db
    environment:
      - POSTGRES_USER=${HASHTAG_DB_USER:-admin}
      - POSTGRES_PASSWORD=${HASHTAG_DB_PASSWORD:-password}
      - POSTGRES_DB=${HASHTAG_DB_NAME:-hashtag_service_db}
    # Removed exposed port - internal network only
    volumes:
      - hashtag-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${HASHTAG_DB_USER:-admin} -d ${HASHTAG_DB_NAME:-hashtag_service_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================================================================
  # 4. BACKEND SERVICES
  # ==================================================================
  api-gateway:
    build:
      context: .
      dockerfile: ./backend/api-gateway/Dockerfile
    container_name: api-gateway
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - NOTIFICATION_DB_HOST=${NOTIFICATION_DB_HOST:-notification-db}
      - NOTIFICATION_DB_USER=${NOTIFICATION_DB_USER:-admin}
      - NOTIFICATION_DB_PASSWORD=${NOTIFICATION_DB_PASSWORD:-password}
      - NOTIFICATION_DB_NAME=${NOTIFICATION_DB_NAME:-notification_service_db}
    # Port removed for security - access through Traefik only
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      notification-db:
        condition: service_healthy
    networks: [hoshi-net]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-gateway.rule=Host(`api.hoshi.local`)"
      - "traefik.http.routers.api-gateway.entrypoints=web"
      - "traefik.http.services.api-gateway.loadbalancer.server.port=8000"

  user-service:
    build: 
      context: .
      dockerfile: ./backend/user-service/Dockerfile
    container_name: user-service
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}     
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET} 
      - GOOGLE_REDIRECT_URL=${GOOGLE_REDIRECT_URL}
      - USER_DB_HOST=${USER_DB_HOST:-user-db}
      - USER_DB_USER=${USER_DB_USER:-admin}
      - USER_DB_PASSWORD=${USER_DB_PASSWORD:-password}
      - USER_DB_NAME=${USER_DB_NAME:-user_service_db}
    depends_on:
      user-db:
        condition: service_healthy
      redis: # Added for Redis connection in main.go
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [hoshi-net]

  post-service:
    build: 
      context: .
      dockerfile: ./backend/post-service/Dockerfile
    container_name: post-service
    environment:
      - POST_DB_HOST=${POST_DB_HOST:-post-db}
      - POST_DB_USER=${POST_DB_USER:-admin}
      - POST_DB_PASSWORD=${POST_DB_PASSWORD:-password}
      - POST_DB_NAME=${POST_DB_NAME:-post_service_db}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
    depends_on:
      post-db:
        condition: service_healthy
      rabbitmq: # <-- ADD THIS BLOCK
        condition: service_healthy
    networks: [hoshi-net]

  story-service:
    build: 
      context: .
      dockerfile: ./backend/story-service/Dockerfile
    container_name: story-service
    environment:
      - STORY_DB_HOST=${STORY_DB_HOST:-story-db}
      - STORY_DB_USER=${STORY_DB_USER:-admin}
      - STORY_DB_PASSWORD=${STORY_DB_PASSWORD:-password}
      - STORY_DB_NAME=${STORY_DB_NAME:-story_service_db}
    depends_on:
      story-db:
        condition: service_healthy
      rabbitmq: # <-- ADD THIS BLOCK
        condition: service_healthy
    networks: [hoshi-net]

  media-service:
    build: 
      context: .
      dockerfile: ./backend/media-service/Dockerfile
    container_name: media-service
    environment:
      - MINIO_INTERNAL_ENDPOINT=${MINIO_INTERNAL_ENDPOINT:-minio:9000}
      - MINIO_EXTERNAL_ENDPOINT=${MINIO_EXTERNAL_ENDPOINT:-localhost:9000}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_REGION=${MINIO_REGION:-us-east-1}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-false}
    depends_on:
      minio:
        condition: service_healthy
    networks: [hoshi-net]

  message-service:
    build: 
      context: .
      dockerfile: ./backend/message-service/Dockerfile
    container_name: message-service
    environment:
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-min-32-characters-long}
      - VIDEOSDK_API_KEY=${VIDEOSDK_API_KEY:-}
      - VIDEOSDK_API_SECRET=${VIDEOSDK_API_SECRET:-}
      - MESSAGE_DB_HOST=${MESSAGE_DB_HOST:-message-db}
      - MESSAGE_DB_USER=${MESSAGE_DB_USER:-admin}
      - MESSAGE_DB_PASSWORD=${MESSAGE_DB_PASSWORD:-password}
      - MESSAGE_DB_NAME=${MESSAGE_DB_NAME:-message_service_db}
    depends_on:
      message-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks: [hoshi-net]

  notification-service:
    build: 
      context: .
      dockerfile: ./backend/notification-service/Dockerfile
    container_name: notification-service
    environment:
      - NOTIFICATION_DB_HOST=${NOTIFICATION_DB_HOST:-notification-db}
      - NOTIFICATION_DB_USER=${NOTIFICATION_DB_USER:-admin}
      - NOTIFICATION_DB_PASSWORD=${NOTIFICATION_DB_PASSWORD:-password}
      - NOTIFICATION_DB_NAME=${NOTIFICATION_DB_NAME:-notification_service_db}
    depends_on:
      notification-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [hoshi-net]

  email-service:
    build: 
      context: .
      dockerfile: ./backend/email-service/Dockerfile
    container_name: email-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks: [hoshi-net]

  worker-service:
    build: 
      context: .
      dockerfile: ./backend/worker-service/Dockerfile
    container_name: worker-service
    environment:
      - STORY_DB_HOST=${STORY_DB_HOST:-story-db}
      - STORY_DB_USER=${STORY_DB_USER:-admin}
      - STORY_DB_PASSWORD=${STORY_DB_PASSWORD:-password}
      - STORY_DB_NAME=${STORY_DB_NAME:-story_service_db}
      - POST_DB_HOST=${POST_DB_HOST:-post-db}
      - POST_DB_USER=${POST_DB_USER:-admin}
      - POST_DB_PASSWORD=${POST_DB_PASSWORD:-password}
      - POST_DB_NAME=${POST_DB_NAME:-post_service_db}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks: [hoshi-net]

  ai-service:
    build: 
      context: .
      dockerfile: ./backend/ai-service/Dockerfile
    container_name: ai-service
    # Removed exposed port - internal network only
    networks: [hoshi-net]
  
  report-service:
    build:
      context: .
      dockerfile: ./backend/report-service/Dockerfile
    container_name: report-service
    environment:
      - REPORT_DB_HOST=${REPORT_DB_HOST:-report-db}
      - REPORT_DB_USER=${REPORT_DB_USER:-admin}
      - REPORT_DB_PASSWORD=${REPORT_DB_PASSWORD:-password}
      - REPORT_DB_NAME=${REPORT_DB_NAME:-report_service_db}
    depends_on:
      report-db:
        condition: service_healthy
      user-service:
        condition: service_started
      post-service:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    networks: [hoshi-net]

  hashtag-service:
    build:
      context: .
      dockerfile: ./backend/hashtag-service/Dockerfile
    container_name: hashtag-service
    environment:
      - HASHTAG_DB_HOST=${HASHTAG_DB_HOST:-hashtag-db}
      - HASHTAG_DB_USER=${HASHTAG_DB_USER:-admin}
      - HASHTAG_DB_PASSWORD=${HASHTAG_DB_PASSWORD:-password}
      - HASHTAG_DB_NAME=${HASHTAG_DB_NAME:-hashtag_service_db}
    depends_on:
      hashtag-db:
        condition: service_healthy
      post-service:
        condition: service_started
    networks: [hoshi-net]


  # ==================================================================
  # 5. FRONTEND SERVICE
  # ==================================================================
  # Frontend service is defined in docker-compose.dev.yml for development
  # For production-only deployment, uncomment the section below:
  #
  # hoshi-vue:
  #   build:
  #     context: ./frontend/hoshi-vue
  #     dockerfile: Dockerfile
  #   container_name: hoshi-vue
  #   networks: [hoshi-net]
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.hoshi-vue.rule=Host(`hoshi.local`)"
  #     - "traefik.http.routers.hoshi-vue.entrypoints=web"
  #     - "traefik.http.services.hoshi-vue.loadbalancer.server.port=80"

# ==================================================================
# VOLUMES & NETWORKS
# ==================================================================
volumes:
  minio-data:
  user-db-data:
  post-db-data:
  story-db-data:
  message-db-data:
  notification-db-data:
  report-db-data:
  hashtag-db-data:

networks:
  hoshi-net:
    driver: bridge