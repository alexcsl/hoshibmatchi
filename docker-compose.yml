# Note: The 'version' attribute is removed as it's obsolete in modern Docker Compose.

services:
  # ==================================================================
  # 1. REVERSE PROXY & ENTRYPOINT
  # ==================================================================
  traefik:
    image: "traefik:v2.10"
    container_name: "traefik"
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # --- DISABLED FOR LOCAL DEV ---
      # - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      # - "--certificatesresolvers.myresolver.acme.email=your-email@example.com"
      # - "--certificatesresolvers.myresolver.acme.storage=/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Traefik Dashboard
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/acme.json:/acme.json"
    networks:
      - hoshi-net

  # ==================================================================
  # 2. CORE INFRASTRUCTURE
  # ==================================================================
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - hoshi-net
    # Added healthcheck for services that depend on Redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio
    container_name: minio
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================================================================
  # 3. DATABASES (Database-per-Service)
  # ==================================================================
  user-db:
    image: postgres:15-alpine
    container_name: user-db
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=user_service_db
    ports:
      - "5431:5432"
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d user_service_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  post-db:
    image: postgres:15-alpine
    container_name: post-db
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=post_service_db
    ports:
      - "5432:5432"
    volumes:
      - post-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d post_service_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  story-db:
    image: postgres:15-alpine
    container_name: story-db
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=story_service_db
    ports:
      - "5433:5432"
    volumes:
      - story-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d story_service_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  message-db:
    image: postgres:15-alpine
    container_name: message-db
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=message_service_db
    ports:
      - "5434:5432"
    volumes:
      - message-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d message_service_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  notification-db:
    image: postgres:15-alpine
    container_name: notification-db
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=notification_service_db
    ports:
      - "5435:5432"
    volumes:
      - notification-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d notification_service_db"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  report-db:
    image: postgres:15-alpine
    container_name: report-db
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=report_service_db
    ports:
      - "5436:5432" # New port
    volumes:
      - report-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d report_service_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  hashtag-db:
    image: postgres:15-alpine
    container_name: hashtag-db
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=hashtag_service_db
    ports:
      - "5437:5432" # New port
    volumes:
      - hashtag-db-data:/var/lib/postgresql/data
    networks:
      - hoshi-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d hashtag_service_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==================================================================
  # 4. BACKEND SERVICES
  # ==================================================================
  api-gateway:
    build:
      context: .
      dockerfile: ./backend/api-gateway/Dockerfile
    container_name: api-gateway
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks: [hoshi-net]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-gateway.rule=Host(`api.hoshi.local`)"
      - "traefik.http.routers.api-gateway.entrypoints=web"
      - "traefik.http.routers.api-gateway.priority=1" # <-- ADD THIS (low priority)
      - "traefik.http.services.api-gateway.loadbalancer.server.port=8000"

  user-service:
    build: 
      context: .
      dockerfile: ./backend/user-service/Dockerfile
    container_name: user-service
    depends_on:
      user-db:
        condition: service_healthy
      redis: # Added for Redis connection in main.go
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [hoshi-net]

  post-service:
    build: 
      context: .
      dockerfile: ./backend/post-service/Dockerfile
    container_name: post-service
    depends_on:
      post-db:
        condition: service_healthy
      rabbitmq: # <-- ADD THIS BLOCK
        condition: service_healthy
    networks: [hoshi-net]

  story-service:
    build: 
      context: .
      dockerfile: ./backend/story-service/Dockerfile
    container_name: story-service
    depends_on:
      story-db:
        condition: service_healthy
      rabbitmq: # <-- ADD THIS BLOCK
        condition: service_healthy
    networks: [hoshi-net]

  media-service:
    build: 
      context: .
      dockerfile: ./backend/media-service/Dockerfile
    container_name: media-service
    depends_on:
      minio:
        condition: service_healthy
    networks: [hoshi-net]

  message-service:
    build: 
      context: .
      dockerfile: ./backend/message-service/Dockerfile
    container_name: message-service
    depends_on:
      message-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks: [hoshi-net]

  notification-service:
    build: 
      context: .
      dockerfile: ./backend/notification-service/Dockerfile
    container_name: notification-service
    depends_on:
      notification-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [hoshi-net]

  email-service:
    build: 
      context: .
      dockerfile: ./backend/email-service/Dockerfile
    container_name: email-service
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks: [hoshi-net]

  worker-service:
    build: 
      context: .
      dockerfile: ./backend/worker-service/Dockerfile
    container_name: worker-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks: [hoshi-net]

  ai-service:
    build: 
      context: .
      dockerfile: ./backend/ai-service/Dockerfile
    container_name: ai-service
    ports:
      - "9008:9008" # Expose the port
    networks: [hoshi-net]
  
  report-service:
    build:
      context: .
      dockerfile: ./backend/report-service/Dockerfile
    container_name: report-service
    depends_on:
      report-db:
        condition: service_healthy
      user-service:
        condition: service_started
      post-service:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    networks: [hoshi-net]

  hashtag-service:
    build:
      context: .
      dockerfile: ./backend/hashtag-service/Dockerfile
    container_name: hashtag-service
    depends_on:
      hashtag-db:
        condition: service_healthy
      post-service:
        condition: service_started
    networks: [hoshi-net]


  # ==================================================================
  # 5. FRONTEND SERVICE
  # ==================================================================
  hoshi-vue:
    build:
      context: ./frontend/hoshi-vue
      dockerfile: Dockerfile
    container_name: hoshi-vue
    networks: [hoshi-net]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hoshi-vue.rule=Host(`hoshi.local`)"
      - "traefik.http.routers.hoshi-vue.entrypoints=web"
      - "traefik.http.services.hoshi-vue.loadbalancer.server.port=80"

# ==================================================================
# VOLUMES & NETWORKS
# ==================================================================
volumes:
  minio-data:
  user-db-data:
  post-db-data:
  story-db-data:
  message-db-data:
  notification-db-data:
  report-db-data:
  hashtag-db-data:

networks:
  hoshi-net:
    driver: bridge