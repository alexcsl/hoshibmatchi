syntax = "proto3";

package post;

option go_package = "github.com/hoshibmatchi/post-service/proto";

// Import user.proto so we can use its types if needed
// (We don't need it for this, but it's good practice
import "user.proto";

service PostService {
  rpc CreatePost (CreatePostRequest) returns (CreatePostResponse);

  rpc LikePost (LikePostRequest) returns (LikePostResponse);
  rpc UnlikePost (LikePostRequest) returns (UnlikePostResponse);
  rpc CommentOnPost (CommentOnPostRequest) returns (CommentResponse);
  rpc GetCommentsByPost (GetCommentsByPostRequest) returns (GetCommentsByPostResponse);
  rpc DeleteComment (DeleteCommentRequest) returns (DeleteCommentResponse);
  rpc GetHomeFeed (GetHomeFeedRequest) returns (GetHomeFeedResponse);
  rpc GetExploreFeed (GetHomeFeedRequest) returns (GetHomeFeedResponse);
  rpc GetReelsFeed (GetHomeFeedRequest) returns (GetHomeFeedResponse);
  rpc GetUserPosts (GetUserContentRequest) returns (GetHomeFeedResponse);
  rpc GetUserReels (GetUserContentRequest) returns (GetHomeFeedResponse);
  rpc GetUserContentCount (GetUserContentCountRequest) returns (GetUserContentCountResponse);

  rpc CreateCollection (CreateCollectionRequest) returns (Collection);
  rpc GetUserCollections (GetUserCollectionsRequest) returns (GetUserCollectionsResponse);
  rpc GetPostsInCollection (GetPostsInCollectionRequest) returns (GetHomeFeedResponse);
  rpc SavePostToCollection (SavePostToCollectionRequest) returns (SavePostToCollectionResponse);
  rpc UnsavePostFromCollection (UnsavePostFromCollectionRequest) returns (UnsavePostFromCollectionResponse);
  rpc DeleteCollection (DeleteCollectionRequest) returns (DeleteCollectionResponse);
  rpc RenameCollection (RenameCollectionRequest) returns (Collection);

  rpc GetPost (GetPostRequest) returns (Post);
  rpc GetPosts (GetPostsRequest) returns (GetPostsResponse);

  rpc DeletePost (DeletePostRequest) returns (DeletePostResponse);

  rpc SharePost (SharePostRequest) returns (SharePostResponse);
  rpc UnsharePost (UnsharePostRequest) returns (UnsharePostResponse);
  rpc GetSharedPosts (GetSharedPostsRequest) returns (GetSharedPostsResponse);
  rpc GetUserTaggedPosts (GetUserContentRequest) returns (GetHomeFeedResponse);
}

// Data from the API Gateway
message CreatePostRequest {
  int64 author_id = 1; // This will come from the JWT token
  string caption = 2;
  repeated string media_urls = 3;
  bool comments_disabled = 4;
  bool is_reel = 5;
  repeated int64 collaborator_ids = 6;
  string location = 8;
  string thumbnail_url = 7;
}

// The created Post
message Post {
  string id = 1;
  int64 author_id = 2; // Added
  string caption = 3;
  
  // Denormalized data
  string author_username = 4;
  string author_profile_url = 5;
  bool author_is_verified = 6;
  
  repeated string media_urls = 7;
  string created_at = 8;
  bool is_reel = 9;

  // Added fields
  bool comments_disabled = 10;
  string thumbnail_url = 11;
  
  // Counts (we'll implement the logic for these later)
  int64 like_count = 12;
  int64 comment_count = 13;
  int64 share_count = 14;
  bool is_liked = 15; // Context-aware: Did the requesting user like this?
  bool is_saved = 16;
  string location = 17;
}

message CreatePostResponse {
  Post post = 1;
}

// --- Like / Unlike a Post ---
message LikePostRequest {
  int64 user_id = 1; // From JWT
  int64 post_id = 2; // From URL
}
message LikePostResponse {
  string message = 1; // "Post liked"
}
message UnlikePostRequest {
  int64 user_id = 1; // From JWT
  int64 post_id = 2; // From URL
}
message UnlikePostResponse {
  string message = 1; // "Post unliked"
}

// --- Comment on a Post ---
message CommentOnPostRequest {
  int64 user_id = 1; // From JWT
  int64 post_id = 2; // From URL
  string content = 3; // Text or GIF URL
  int64 parent_comment_id = 4; // 0 for a top-level comment
}
// Response for a comment includes denormalized data
message CommentResponse {
  string id = 1;
  string content = 2;
  string author_username = 3;
  string author_profile_url = 4;
  string created_at = 5;
  int64 post_id = 6;
  int64 parent_comment_id = 7;
}

// --- Delete a Comment ---
message DeleteCommentRequest {
  int64 user_id = 1; // From JWT (to verify ownership)
  int64 comment_id = 2; // From URL
}
message DeleteCommentResponse {
  string message = 1; // "Comment deleted"
}

// --- Get Comments for a Post ---
message GetCommentsByPostRequest {
  int64 post_id = 1;
  int32 page_size = 2;
  int32 page_offset = 3;
}
message GetCommentsByPostResponse {
  repeated CommentResponse comments = 1;
}

// --- Get Home Feed ---
message GetHomeFeedRequest {
  int64 user_id = 1; // From JWT
  int32 page_size = 2; // For pagination
  int32 page_offset = 3; // For pagination
}

// We can re-use the Post message we already defined
message GetHomeFeedResponse {
  repeated Post posts = 1;
}

// --- Get User's Posts/Reels ---
message GetUserContentRequest {
  int64 user_id = 1; // The profile owner
  int32 page_size = 2;
  int32 page_offset = 3;
  int64 requester_id = 4; // Who is viewing (from JWT)
}

message GetUserContentCountRequest {
  int64 user_id = 1;
}

message GetUserContentCountResponse {
  int64 post_count = 1;
  int64 reel_count = 2;
}

// --- Collection Messages ---
message Collection {
  string id = 1;
  string user_id = 2;
  string name = 3;
  // TODO: Add cover_image_urls from the 4 most recent posts
}

// --- Create Collection ---
message CreateCollectionRequest {
  int64 user_id = 1;
  string name = 2;
}
// Returns a 'Collection' message

// --- Get User Collections ---
message GetUserCollectionsRequest {
  int64 user_id = 1;
}
message GetUserCollectionsResponse {
  repeated Collection collections = 1;
}

// --- Get Posts in Collection ---
message GetPostsInCollectionRequest {
  int64 user_id = 1; // For validation
  int64 collection_id = 2;
  int32 page_size = 3;
  int32 page_offset = 4;
}
// Returns a 'GetHomeFeedResponse' (which is just a list of posts)

// --- Save/Unsave Post ---
message SavePostToCollectionRequest {
  int64 user_id = 1; // For validation
  int64 collection_id = 2;
  int64 post_id = 3;
}
message SavePostToCollectionResponse {
  string message = 1;
}

message UnsavePostFromCollectionRequest {
  int64 user_id = 1; // For validation
  int64 collection_id = 2;
  int64 post_id = 3;
}
message UnsavePostFromCollectionResponse {
  string message = 1;
}

// --- Delete/Rename Collection ---
message DeleteCollectionRequest {
  int64 user_id = 1;
  int64 collection_id = 2;
}
message DeleteCollectionResponse {
  string message = 1;
}

message RenameCollectionRequest {
  int64 user_id = 1;
  int64 collection_id = 2;
  string new_name = 3;
}
// Returns a 'Collection' message

// --- Get Post ---
message GetPostRequest {
  int64 post_id = 1;
}

// --- Get Posts (Batched) ---
message GetPostsRequest {
  repeated int64 post_ids = 1;
}

message GetPostsResponse {
  repeated Post posts = 1;
}

// --- Admin: Delete Post ---
message DeletePostRequest {
  int64 post_id = 1;
  int64 admin_user_id = 2; // From JWT, for logging
}

message DeletePostResponse {
  string message = 1; // e.g., "Post deleted successfully"
}

// --- Share Post ---
message SharePostRequest {
  int64 user_id = 1; // From JWT - who is sharing
  int64 post_id = 2; // The post being shared
  string caption = 3; // Optional comment when sharing
}

message SharePostResponse {
  string message = 1;
  int64 shared_post_id = 2; // ID of the SharedPost record
}

// --- Unshare Post ---
message UnsharePostRequest {
  int64 user_id = 1; // From JWT
  int64 post_id = 2; // The post to unshare
}

message UnsharePostResponse {
  string message = 1;
}

// --- Get Shared Posts ---
message GetSharedPostsRequest {
  int64 user_id = 1; // Get posts shared by this user
  int32 page_size = 2;
  int32 page_offset = 3;
}

message SharedPostItem {
  string id = 1;
  Post original_post = 2;
  string shared_by_username = 3;
  string shared_caption = 4;
  string shared_at = 5;
}

message GetSharedPostsResponse {
  repeated SharedPostItem shared_posts = 1;
}