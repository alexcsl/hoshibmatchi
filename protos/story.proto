syntax = "proto3";

package story;

option go_package = "github.com/hoshibmatchi/story-service/proto";

// Import user.proto to get user data
import "user.proto";

service StoryService {
  rpc CreateStory (CreateStoryRequest) returns (CreateStoryResponse);

  rpc LikeStory (LikeStoryRequest) returns (LikeStoryResponse);
  rpc UnlikeStory (UnlikeStoryRequest) returns (UnlikeStoryResponse);
  rpc ViewStory (ViewStoryRequest) returns (ViewStoryResponse);
  // NEW: Get the story feed
  rpc GetStoryFeed (GetStoryFeedRequest) returns (GetStoryFeedResponse);
  // NEW: Delete story (for worker or user)
  rpc DeleteStory (DeleteStoryRequest) returns (DeleteStoryResponse);
  // NEW: Get user's archive (all their stories)
  rpc GetUserArchive (GetUserArchiveRequest) returns (GetUserArchiveResponse);
}

// Data from the API Gateway
message CreateStoryRequest {
  int64 author_id = 1; // From the JWT
  string media_url = 2; // Stories are usually a single media item
  string media_type = 3;
  string caption = 4;
  string filter_name = 5; 
  string stickers_json = 6;
  bool close_friends_only = 7;
}

// The created Story
message Story {
  string id = 1;
  string media_url = 2;
  string media_type = 3;
  string caption = 4;
  string author_username = 5;
  string author_profile_url = 6;
  string created_at = 7;
  string expires_at = 8;
  bool is_liked = 9;
  string filter_name = 10;
  string stickers_json = 11;
  bool close_friends_only = 12;
}

message CreateStoryResponse {
  Story story = 1;
}

message GetStoryFeedRequest {
  int64 user_id = 1; // The viewer
}

// We group stories by Author so the Frontend can render the "Circles"
message UserStoryGroup {
  int64 user_id = 1;
  string username = 2;
  string user_profile_url = 3;
  repeated Story stories = 4;
  bool all_seen = 5; // Optional: if we track views later
}

message GetStoryFeedResponse {
  repeated UserStoryGroup story_groups = 1;
}

message LikeStoryRequest {
  int64 user_id = 1; // From JWT
  int64 story_id = 2; // From URL
}
message LikeStoryResponse {
  string message = 1; // "Story liked"
}
message UnlikeStoryRequest {
  int64 user_id = 1; // From JWT
  int64 story_id = 2; // From URL
}
message UnlikeStoryResponse {
  string message = 1; // "Story unliked"
}

message ViewStoryRequest {
  int64 user_id = 1; // From JWT
  int64 story_id = 2; // From URL
}

message ViewStoryResponse {
  string message = 1; // "Story viewed"
}

message DeleteStoryRequest {
    int64 user_id = 1; // Owner or Admin
    int64 story_id = 2;
}
message DeleteStoryResponse {
    string message = 1;
}

message GetUserArchiveRequest {
    int64 user_id = 1; // The user whose archive we want to fetch
}
message GetUserArchiveResponse {
    repeated Story stories = 1;
}