syntax = "proto3";

package user;

// This is the correct go_package we settled on
option go_package = "github.com/hoshibmatchi/user-service/proto";

service UserService {
  // From Auth
  rpc RegisterUser (RegisterUserRequest) returns (RegisterUserResponse);
  rpc SendRegistrationOtp (SendOtpRequest) returns (SendOtpResponse);
  // NEW: This service will verify the OTP and return tokens
  rpc VerifyRegistrationOtp (VerifyRegistrationOtpRequest) returns (VerifyRegistrationOtpResponse);
  rpc LoginUser (LoginRequest) returns (LoginResponse);
  
  // From 2FA
  rpc Verify2FA (Verify2FARequest) returns (Verify2FAResponse);

  // From Password Reset
  rpc SendPasswordReset (SendPasswordResetRequest) returns (SendPasswordResetResponse);
  rpc ResetPassword (ResetPasswordRequest) returns (ResetPasswordResponse);

  // From Post Service integration
  rpc GetUserData (GetUserDataRequest) returns (GetUserDataResponse);

  rpc FollowUser (FollowUserRequest) returns (FollowUserResponse);
  rpc UnfollowUser (UnfollowUserRequest) returns (UnfollowUserResponse);
  rpc IsFollowing (IsFollowingRequest) returns (IsFollowingResponse);

  rpc GetFollowingList (GetFollowingListRequest) returns (GetFollowingListResponse);
  rpc GetUserProfile (GetUserProfileRequest) returns (GetUserProfileResponse);

  rpc UpdateUserProfile (UpdateUserProfileRequest) returns (GetUserProfileResponse);
  rpc SetAccountPrivacy (SetAccountPrivacyRequest) returns (SetAccountPrivacyResponse);

  rpc BlockUser (BlockUserRequest) returns (BlockUserResponse);
  rpc UnblockUser (UnblockUserRequest) returns (UnblockUserResponse);

  rpc SearchUsers (SearchUsersRequest) returns (SearchUsersResponse);

  // Admin controls
  rpc BanUser (BanUserRequest) returns (BanUserResponse);
  rpc UnbanUser (UnbanUserRequest) returns (UnbanUserResponse);

  // Admin: Newsletter
  rpc SendNewsletter (SendNewsletterRequest) returns (SendNewsletterResponse);

  // Verification Requests
  rpc SubmitVerificationRequest (SubmitVerificationRequestRequest) returns (SubmitVerificationRequestResponse);
  rpc GetVerificationRequests (GetVerificationRequestsRequest) returns (GetVerificationRequestsResponse);
  rpc ResolveVerificationRequest (ResolveVerificationRequestRequest) returns (ResolveVerificationRequestResponse);


  // Googel OAuth
  rpc HandleGoogleAuth (HandleGoogleAuthRequest) returns (LoginResponse); 
}

// --- Register ---
message RegisterUserRequest {
  string name = 1;
  string username = 2;
  string email = 3;
  string password = 4;
  string date_of_birth = 5;
  string gender = 6;
  // string profile_picture_url = 7; // REMOVED
  // string otp_code = 8; // REMOVED
  string confirm_password = 9; // ADDED
}

message RegisterUserResponse {
  int64 id = 1; // Return the new User ID
  string username = 2;
  string email = 3;
  string message = 4; // e.g., "Registration successful. Please check email."
}

// --- Send OTP ---
message SendOtpRequest {
  string email = 1;
}

message SendOtpResponse {
  string message = 1;
  int32 rate_limit_seconds = 2;
}

message HandleGoogleAuthRequest {
  string auth_code = 1;
}

// --- NEW: Verify Registration OTP ---
message VerifyRegistrationOtpRequest {
  string email = 1;
  string otp_code = 2;
}

// Returns tokens, officially "logging in" the new user
message VerifyRegistrationOtpResponse {
  string access_token = 1;
  string refresh_token = 2;
}


// --- Login ---
message LoginRequest {
  string email_or_username = 1;
  string password = 2;
}

message LoginResponse {
  string message = 1;
  string access_token = 2;
  string refresh_token = 3;
  bool is_2fa_required = 4;
}

// --- 2FA Verification ---
message Verify2FARequest {
  string email = 1;
  string otp_code = 2;
}

message Verify2FAResponse {
  string access_token = 1;
  string refresh_token = 2;
}

// --- Password Reset (Request) ---
message SendPasswordResetRequest {
  string email = 1;
}

message SendPasswordResetResponse {
  string message = 1;
}

// --- Password Reset (Submit) ---
message ResetPasswordRequest {
  string email = 1;
  string otp_code = 2;
  string new_password = 3;
}

message ResetPasswordResponse {
  string message = 1;
}

// --- Get User Data (for service-to-service) ---
message GetUserDataRequest {
  int64 user_id = 1;
}

message GetUserDataResponse {
  string username = 1;
  string profile_picture_url = 2;
  bool is_verified = 3;
}

// --- Follow / Unfollow User ---
message FollowUserRequest {
  int64 follower_id = 1; // The user initiating the follow (from JWT)
  int64 following_id = 2; // The user to be followed (from URL)
}

message FollowUserResponse {
  string message = 1; // "Successfully followed user"
}

message UnfollowUserRequest {
  int64 follower_id = 1; // The user initiating the unfollow
  int64 following_id = 2; // The user to be unfollowed
}

message UnfollowUserResponse {
  string message = 1; // "Successfully unfollowed user"
}

// --- Check if Following ---
message IsFollowingRequest {
  int64 follower_id = 1; // The user who might be following
  int64 following_id = 2; // The user to check
}

message IsFollowingResponse {
  bool is_following = 1;
}

message GetFollowingListRequest {
  int64 user_id = 1; // The user who is asking
}

message GetFollowingListResponse {
  repeated int64 following_user_ids = 1; // A list of user IDs
}

// --- Get User Profile ---
message GetUserProfileRequest {
  string username = 1; // The username of the profile we want to view
  int64 self_user_id = 2; // The ID of the user making the request (from JWT)
}

message GetUserProfileResponse {
  int64 user_id = 1;
  string name = 2;
  string username = 3;
  string bio = 4; // We need to add this to our GORM model
  string profile_picture_url = 5;
  bool is_verified = 6;
  int64 follower_count = 7;
  int64 following_count = 8;
  bool is_followed_by_self = 9; // Does the person viewing follow this profile?
  int64 mutual_follower_count = 10;
  string gender = 11;
  bool is_private = 12;
}

// --- Edit User Profile ---
message UpdateUserProfileRequest {
  int64 user_id = 1; // From JWT
  string name = 2;
  string bio = 3;
  string gender = 4;
  // We'll add ProfilePictureURL later
}

// --- Set Account Privacy ---
message SetAccountPrivacyRequest {
  int64 user_id = 1; // From JWT
  bool is_private = 2;
}

message SetAccountPrivacyResponse {
  string message = 1;
}

// --- Block / Unblock User ---
message BlockUserRequest {
  int64 blocker_id = 1; // The user initiating the block (from JWT)
  int64 blocked_id = 2; // The user to be blocked (from URL)
}

message BlockUserResponse {
  string message = 1; // "Successfully blocked user"
}

message UnblockUserRequest {
  int64 blocker_id = 1; // The user initiating the unblock
  int64 blocked_id = 2; // The user to be unblocked
}

message UnblockUserResponse {
  string message = 1; // "Successfully unblocked user"
}

// --- Search Users ---
message SearchUsersRequest {
  string query = 1; // The search term
  int64 self_user_id = 2; // From JWT, to exclude self from results
}

// We can re-use GetUserProfileResponse
message SearchUsersResponse {
  repeated GetUserProfileResponse users = 1;
}

// Admin Controls
// --- Admin: Ban / Unban ---
message BanUserRequest {
  int64 admin_user_id = 1; // From JWT
  int64 user_to_ban_id = 2; // From URL
}

message BanUserResponse {
  string message = 1; // e.g., "User banned successfully"
}

message UnbanUserRequest {
  int64 admin_user_id = 1; // From JWT
  int64 user_to_unban_id = 2; // From URL
}

message UnbanUserResponse {
  string message = 1; // e.g., "User unbanned successfully"
}

// --- Admin: Newsletter ---
message SendNewsletterRequest {
  int64 admin_user_id = 1; // From JWT
  string subject = 2;
  string body = 3;
}

message SendNewsletterResponse {
  string message = 1;
  int32 recipients_count = 2;
}

// --- User: Submit Verification ---
message VerificationRequest {
  string id = 1;
  int64 user_id = 2;
  string id_card_number = 3;
  string face_picture_url = 4;
  string reason = 5;
  string status = 6;
  string created_at = 7;
  string username = 8; // Denormalized
}

message SubmitVerificationRequestRequest {
  int64 user_id = 1; // From JWT
  string id_card_number = 2;
  string face_picture_url = 3;
  string reason = 4;
}

message SubmitVerificationRequestResponse {
  VerificationRequest request = 1;
}

// --- Admin: Manage Verifications ---
message GetVerificationRequestsRequest {
  int32 page_size = 1;
  int32 page_offset = 2;
  string status = 3; // "pending", "approved", "rejected"
}

message GetVerificationRequestsResponse {
  repeated VerificationRequest requests = 1;
}

message ResolveVerificationRequestRequest {
  int64 admin_user_id = 1; // From JWT
  int64 request_id = 2;
  string action = 3; // "APPROVE" or "REJECT"
}

message ResolveVerificationRequestResponse {
  string message = 1;
}