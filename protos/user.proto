syntax = "proto3";

package user;

// This is the correct go_package we settled on
option go_package = "github.com/hoshibmatchi/user-service/proto";

service UserService {
  // From Auth
  rpc RegisterUser (RegisterUserRequest) returns (RegisterUserResponse);
  rpc SendRegistrationOtp (SendOtpRequest) returns (SendOtpResponse);
  rpc LoginUser (LoginRequest) returns (LoginResponse);
  
  // From 2FA
  rpc Verify2FA (Verify2FARequest) returns (Verify2FAResponse);

  // From Password Reset
  rpc SendPasswordReset (SendPasswordResetRequest) returns (SendPasswordResetResponse);
  rpc ResetPassword (ResetPasswordRequest) returns (ResetPasswordResponse);

  // From Post Service integration
  rpc GetUserData (GetUserDataRequest) returns (GetUserDataResponse);

  rpc FollowUser (FollowUserRequest) returns (FollowUserResponse);
  rpc UnfollowUser (UnfollowUserRequest) returns (UnfollowUserResponse);

  rpc GetFollowingList (GetFollowingListRequest) returns (GetFollowingListResponse);
  rpc GetUserProfile (GetUserProfileRequest) returns (GetUserProfileResponse);
}

// --- Register ---
message RegisterUserRequest {
  string name = 1;
  string username = 2;
  string email = 3;
  string password = 4;
  string date_of_birth = 5;
  string gender = 6;
  string profile_picture_url = 7;
  string otp_code = 8;
}

message RegisterUserResponse {
  int64 id = 1;
  string username = 2;
  string email = 3;
}

// --- Send OTP ---
message SendOtpRequest {
  string email = 1;
}

message SendOtpResponse {
  string message = 1;
  int32 rate_limit_seconds = 2;
}

// --- Login ---
message LoginRequest {
  string email_or_username = 1;
  string password = 2;
}

message LoginResponse {
  string message = 1;
  string access_token = 2;
  string refresh_token = 3;
  bool is_2fa_required = 4;
}

// --- 2FA Verification ---
message Verify2FARequest {
  string email = 1;
  string otp_code = 2;
}

message Verify2FAResponse {
  string access_token = 1;
  string refresh_token = 2;
}

// --- Password Reset (Request) ---
message SendPasswordResetRequest {
  string email = 1;
}

message SendPasswordResetResponse {
  string message = 1;
}

// --- Password Reset (Submit) ---
message ResetPasswordRequest {
  string email = 1;
  string otp_code = 2;
  string new_password = 3;
}

message ResetPasswordResponse {
  string message = 1;
}

// --- Get User Data (for service-to-service) ---
message GetUserDataRequest {
  int64 user_id = 1;
}

message GetUserDataResponse {
  string username = 1;
  string profile_picture_url = 2;
  bool is_verified = 3;
}

// --- Follow / Unfollow User ---
message FollowUserRequest {
  int64 follower_id = 1; // The user initiating the follow (from JWT)
  int64 following_id = 2; // The user to be followed (from URL)
}

message FollowUserResponse {
  string message = 1; // "Successfully followed user"
}

message UnfollowUserRequest {
  int64 follower_id = 1; // The user initiating the unfollow
  int64 following_id = 2; // The user to be unfollowed
}

message UnfollowUserResponse {
  string message = 1; // "Successfully unfollowed user"
}

message GetFollowingListRequest {
  int64 user_id = 1; // The user who is asking
}

message GetFollowingListResponse {
  repeated int64 following_user_ids = 1; // A list of user IDs
}

// --- Get User Profile ---
message GetUserProfileRequest {
  string username = 1; // The username of the profile we want to view
  int64 self_user_id = 2; // The ID of the user making the request (from JWT)
}

message GetUserProfileResponse {
  int64 user_id = 1;
  string name = 2;
  string username = 3;
  string bio = 4; // We need to add this to our GORM model
  string profile_picture_url = 5;
  bool is_verified = 6;
  int64 follower_count = 7;
  int64 following_count = 8;
  bool is_followed_by_self = 9; // Does the person viewing follow this profile?
  int64 mutual_follower_count = 10;
}